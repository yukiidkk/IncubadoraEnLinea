<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Creaci√≥n de nuevo proyecto</title>
  <link rel="stylesheet" href="css/estilos.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f1f1;
      margin: 0;
    }

    header {
      background-color: #003366;
      color: white;
      padding: 10px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    header img {
      height: 35px;
    }

    header nav a {
      color: white;
      text-decoration: none;
      margin-right: 20px;
      font-weight: bold;
    }

    header nav a:hover {
      text-decoration: underline;
    }

    .usuario {
      font-weight: bold;
      background-color: white;
      color: #003366;
      padding: 6px 15px;
      border-radius: 20px;
    }

    .contenido {
      padding: 20px 40px;
    }

    h1 {
      text-align: center;
      color: #003366;
    }

    .subnav {
      text-align: center;
      margin-bottom: 25px;
    }

    .subnav a {
      margin: 0 15px;
      color: #003366;
      font-weight: 500;
      text-decoration: none;
    }

    .acciones {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .acciones input[type="text"],
    .acciones select {
      padding: 6px;
      border: 1px solid #aaa;
      border-radius: 5px;
      min-width: 180px;
    }

    .acciones button {
      background-color: #1e63b5;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .acciones button:hover {
      background-color: #004b9a;
    }

    .acciones .descargar {
      background-color: #759fcf;
    }

    /* --- Secci√≥n de formulario --- */
    .formulario {
      background-color: #c9dcfa;
      border: 1px solid #999;
      border-radius: 4px;
      padding: 20px;
      margin-top: 10px;
    }

    .formulario h3 {
      background-color: #e8eef8;
      border-bottom: 1px solid #999;
      margin-top: 0;
      padding: 8px;
      color: #003366;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }

    input[type="text"], textarea, select {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #888;
      font-family: inherit;
    }

    textarea {
      resize: none;
      height: 100px;
    }

    .socios {
      border: 1px solid #999;
      background-color: white;
      height: 150px;
      overflow-y: auto;
      padding: 8px;
    }

    .socios div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }

    .socios label {
      margin: 0;
    }

    .a√±adir {
      color: green;
      font-weight: bold;
      cursor: pointer;
    }

    .eliminar {
      color: red;
      font-weight: bold;
      cursor: pointer;
    }

    .buscar-socio {
      display: flex;
      margin-top: 8px;
      gap: 8px;
    }

    .buscar-socio input {
      flex: 1;
    }

    .botones {
      text-align: center;
      margin-top: 20px;
    }

    .botones button {
      margin: 0 8px;
      background-color: #1e63b5;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .botones button:hover {
      background-color: #004b9a;
    }

    .socios {
  border: 1px solid #999;
  background-color: #e8eef8;
  border-radius: 6px;
  padding: 10px;
  max-height: 250px;
  overflow-y: auto;
}

/* Tarjeta individual de socio */
.socio-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px 15px;
  margin-bottom: 10px;
  transition: box-shadow 0.2s ease;
}

.socio-card:hover {
  box-shadow: 0 0 5px rgba(0,0,0,0.15);
}

.socio-card .info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.socio-card img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
}

.acciones-socio {
  display: flex;
  gap: 8px;
}

.btn-add, .btn-del {
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  font-weight: bold;
  cursor: pointer;
  color: white;
}

.btn-add {
  background-color: #2e8b57; /* verde */
}

.btn-del {
  background-color: #c62828; /* rojo */
}

.btn-add:hover {
  background-color: #256f46;
}

.btn-del:hover {
  background-color: #a61b1b;
}

.subir-archivo {
  background-color: #e8eef8;
  border: 1px solid #999;
  border-radius: 6px;
  padding: 10px;
}

input[type="file"] {
  width: 100%;
  border: none;
  background-color: #fff;
  border-radius: 4px;
  padding: 8px;
  cursor: pointer;
  font-family: inherit;
  color: #003366;
}

input[type="file"]::-webkit-file-upload-button {
  background-color: #1e63b5;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 6px 12px;
  cursor: pointer;
  font-weight: bold;
}

input[type="file"]::-webkit-file-upload-button:hover {
  background-color: #004b9a;
}
.socios-agregados {
  margin-top: 15px;
  background-color: #e8eef8;
  border: 1px solid #999;
  border-radius: 6px;
  padding: 10px 15px;
}

.socios-agregados h4 {
  margin-top: 0;
  color: #003366;
}

#listaSocios {
  list-style: none;
  padding: 0;
  margin: 0;
}

#listaSocios li {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 6px 10px;
  margin-bottom: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#listaSocios li span {
  color: #003366;
  font-weight: bold;
}

#listaSocios button {
  background-color: #c62828;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 3px 8px;
  cursor: pointer;
}

#listaSocios button:hover {
  background-color: #a61b1b;
}

  </style>
</head>
<body>

   <header>
    <div class="left">
      <img src="images/logoITS.png" alt="Logo ITS">
      <span>Instituto Tecnol√≥gico de Saltillo</span>
      <nav>
        <a href="inicioE.html">Home</a>
        <a href="proyectos.html">Proyectos</a>
      </nav>
    </div>
    <div class="usuario" id="nombreUsuario">USUARIO</div>
  </header>

  <div class="contenido">
    <h1>P√°gina principal de proyectos</h1>

    <div class="subnav">
      <a href="proyectos.html">Inicio</a> |
      <a href="#">Seguimiento de proyectos</a>
    </div>

    <div class="acciones">
      <input type="text" placeholder="Buscar..">
      <select>
        <option value="">Filtrar por...</option>
      </select>
      <button onclick="location.href='crearProyecto.html'">Crear nuevo proyecto ‚ûï</button>
      <button class="descargar">Descargar formato de registro</button>
    </div>

    <div class="formulario" id="formProyecto">
      <h3>Creaci√≥n de nuevo proyecto</h3>

      <div class="form-grid">
        <div>
          <label for="nombreProyecto">Nombre del proyecto</label>
          <input type="text" id="nombreProyecto">
          <label for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion"></textarea>
        </div>
        <div>
          <label for="archivo">Subir formato de registro:</label>
          <div class="subir-archivo">
            <input type="file" id="archivo" name="archivo" accept=".doc,.docx,.pdf">
          </div>

          <label>Agregar socios:</label>

          <div class="agregarSocios" id="agregarSocios">
            <div class="socio-card">
              <div class="info">
                <img src="images/user-icon.png" alt="icono usuario">
                <span><strong>USUARIO 1</strong></span>
              </div>
              <div class="acciones-socio">
                <button class="btn-add" data-nombre="USUARIO 1">A√±adir</button>
              </div>
            </div>

            <div class="socio-card">
              <div class="info">
                <img src="images/user-icon.png" alt="icono usuario">
                <span><strong>USUARIO 2</strong></span>
              </div>
              <div class="acciones-socio">
                <button class="btn-add" data-nombre="USUARIO 2">A√±adir</button>
              </div>
            </div>

            <div class="socio-card">
              <div class="info">
                <img src="images/user-icon.png" alt="icono usuario">
                <span><strong>USUARIO 3</strong></span>
              </div>
              <div class="acciones-socio">
                <button class="btn-add" data-nombre="USUARIO 3">A√±adir</button>
              </div>
            </div>
          </div>

          <div class="buscar-socio">
            <input type="text" id="buscarSocioInput" placeholder="Buscar usuario por nombre...">
            <button id="btnBuscarSocio">Buscar</button>
          </div>

          <div class="socios-agregados">
            <h4>Socios agregados al proyecto:</h4>
            <ul id="listaSocios"></ul>
          </div>
        </div>
      </div>

      <div class="botones">
        <button id="btnGuardar">Guardar</button>
        <button id="btnLimpiar">Limpiar campos</button>
        <a href="proyectos.html"><button type="button">Cerrar</button></a>
      </div>
    </div>
  </div>

 <script>
    // ========== VARIABLES GLOBALES ==========
    const sociosAgregados = [];

    // ========== INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Mostrar nombre de usuario
      const usuario = localStorage.getItem('usuario');
      if (usuario) {
        document.getElementById('nombreUsuario').textContent = usuario;
      }

      // Verificar que el usuario est√© logueado
      const id_usuario = localStorage.getItem('id_usuario');
      if (!id_usuario) {
        alert('Debes iniciar sesi√≥n primero');
        window.location.href = 'login.html';
        return;
      }
    });

    // ========== GESTI√ìN DE SOCIOS ==========
    document.addEventListener('click', (e) => {
      // A√±adir socio
      if (e.target.classList.contains('btn-add')) {
        const nombre = e.target.dataset.nombre;

        // Verificar si ya est√° agregado
        const existe = sociosAgregados.includes(nombre);
        if (existe) {
          alert(`${nombre} ya est√° agregado al proyecto.`);
          return;
        }

        // Agregar a la lista
        sociosAgregados.push(nombre);
        actualizarListaSocios();
        alert(`${nombre} ha sido agregado al proyecto`);
      }

      // Eliminar socio de la lista
      if (e.target.classList.contains('btnEliminarSocio')) {
        const li = e.target.parentElement;
        const nombre = li.dataset.nombre;
        
        const index = sociosAgregados.indexOf(nombre);
        if (index > -1) {
          sociosAgregados.splice(index, 1);
        }
        li.remove();
      }
    });

    function actualizarListaSocios() {
      const listaSocios = document.getElementById('listaSocios');
      listaSocios.innerHTML = '';
      
      sociosAgregados.forEach(nombre => {
        const li = document.createElement('li');
        li.dataset.nombre = nombre;
        li.innerHTML = `
          <span>${nombre}</span>
          <button class="btnEliminarSocio">Quitar</button>
        `;
        listaSocios.appendChild(li);
      });
    }

    // ========== GUARDAR PROYECTO ==========
   
 document.getElementById('btnGuardar').addEventListener('click', async () => {
  const nombreProyecto = document.getElementById('nombreProyecto').value.trim();
  const descripcion = document.getElementById('descripcion').value.trim();
  const archivoInput = document.querySelector('#archivo');

  // üîπ Aqu√≠ guardas los socios que el usuario haya agregado (puede ser un arreglo vac√≠o)
  const sociosAgregados = window.sociosAgregados || [];

  // Validaciones
  if (!nombreProyecto || !descripcion) {
    alert('Por favor, completa todos los campos obligatorios.');
    return;
  }

  // Obtener id_usuario del localStorage
  const id_usuario = localStorage.getItem('id_usuario');
  if (!id_usuario) {
    alert('Error: no se encontr√≥ el usuario en sesi√≥n.');
    return;
  }

  let archivoBase64 = "";

  // üîπ Si el usuario sube un archivo, convertirlo a Base64
  if (archivoInput.files.length > 0) {
    const archivo = archivoInput.files[0];
    const reader = new FileReader();

    reader.onloadend = async () => {
      archivoBase64 = reader.result.split(",")[1]; // quitar el encabezado "data:application/pdf;base64,"

      await guardarProyecto(id_usuario, nombreProyecto, descripcion, archivoBase64, sociosAgregados);
    };

    reader.readAsDataURL(archivo); // <-- inicia la lectura del archivo
  } else {
    // üîπ Si no se sube archivo, enviar vac√≠o
    await guardarProyecto(id_usuario, nombreProyecto, descripcion, "", sociosAgregados);
  }
});


// üîπ Funci√≥n separada para enviar los datos al backend
async function guardarProyecto(id_usuario, nombreProyecto, descripcion, archivoBase64, socios) {
  try {
    console.log("üì§ Enviando datos al servidor...");
    console.log({ id_usuario, nombreProyecto, descripcion, socios });

    const response = await fetch('http://localhost:3001/api/crearProyecto', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id_usuario: parseInt(id_usuario),
        nombre_proyecto: nombreProyecto,
        descripcion,
        archivoBase64,
        socios
      }),
    });

    const data = await response.json();

    if (response.ok) {
      alert('‚úÖ Proyecto creado con √©xito');
      limpiarCampos();
      window.location.href = 'proyectos.html';
    } else {
      alert('‚ùå Error: ' + (data.mensaje || 'No se pudo guardar el proyecto.'));
    }
  } catch (error) {
    console.error('Error al guardar:', error);
    alert('Error de conexi√≥n con el servidor');
  }
}


// üîπ Funci√≥n auxiliar para limpiar los campos
function limpiarCampos() {
  document.getElementById('nombreProyecto').value = "";
  document.getElementById('descripcion').value = "";
  document.querySelector('#archivo').value = "";
}


    // ========== LIMPIAR CAMPOS ==========
    document.getElementById('btnLimpiar').addEventListener('click', function() {
      limpiarCampos();
      alert('Todos los campos han sido limpiados');
    });

    function limpiarCampos() {
      document.getElementById('nombreProyecto').value = '';
      document.getElementById('descripcion').value = '';
      document.getElementById('archivo').value = '';
      document.getElementById('listaSocios').innerHTML = '';
      sociosAgregados.length = 0;
    }

    // ========== BUSCAR SOCIOS (placeholder) ==========
    document.getElementById('btnBuscarSocio').addEventListener('click', function() {
      const termino = document.getElementById('buscarSocioInput').value.trim();
      if (termino) {
        alert(`Funcionalidad de b√∫squeda para: ${termino} - Esta funci√≥n est√° en desarrollo`);
      } else {
        alert('Por favor, ingresa un nombre para buscar');
      }
    });
  </script>

</body>
</html>
