<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Emprendurismo ITS</title>
    <link rel="shortcut icon" href="./images/logoITS.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./css/estilos.css">
</head>
<body>

    <header class="navbar">
        <div class="container nav-content">
            <div class="logo">
                <img src="./images/logoITS.png" alt="ITS" />
                <span>Instituto Tecnol贸gico de Saltillo</span>
            </div>

            <div class="user-info">
                <span class="user-text" id="nombreUsuarioDisplay">USUARIO</span>
                <div class="user-icon"></div>
            </div>
        </div>
        <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; }
    body { background-color: #f3f4f6; color: #001d3d; }
    .navbar { background: #003366; color: #fff; height: 50px; display: flex; align-items: center; }
    .nav-content { display: flex; justify-content: space-between; align-items: center; width: 90%; margin: 0 auto; }
    .logo { display: flex; align-items: center; }
    .logo img { width: 30px; height: 30px; margin-right: 8px; }
    .nav-right { font-weight: bold; font-size: 14px; }
    .container { padding: 40px; }
    .container h2 { color: #001d3d; font-size: 24px; margin-bottom: 20px; }
    .paneles { display: flex; gap: 40px; flex-wrap: wrap; }
    .panel { background-color: #dbe7ff; flex: 1; border-radius: 10px; padding: 25px; min-width: 300px; }
    label { display: block; font-weight: 600; margin-top: 10px; }
    input[type="text"], select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; }
    th { background-color: #e0ebff; font-weight: 600; }
    tr:hover { background-color: #f2f6ff; }
    .botones { display: flex; justify-content: space-between; margin-top: 15px; flex-wrap: wrap; gap: 10px; }
    .btn { background-color: #003366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1; min-width: 120px; }
    .btn:hover { background-color: #001f54; }
    .buscar { display: flex; gap: 10px; margin-bottom: 15px; }
    @media (max-width: 768px) { .paneles { flex-direction: column; } .botones { flex-direction: column; align-items: stretch; } }
  </style>
    </header>
    
    <div class="main-content role-management-view">
        <div class="form-container">
            <header>
                <h2>Tipos de Eventos</h2>
            </header>
            
            <div class="paneles">
      <section class="panel">
        <label>Nombre del tipo de evento </label>
        <input type="text" id="nombreTipoEInput" placeholder="Nombre del tipo de evento">

        <h3>Tipo de evento creados</h3>
        <table>
          <thead>
            <tr>
              <th>Tipo de Evento</th>
            </tr>
          </thead>
          <tbody id="tablaTipoEvento"></tbody>
        </table>

        <div class="botones">
          <button class="btn" id="btnCrear">Crear</button>
          <button class="btn" id="btnActualizar">Actualizar</button>
          <button class="btn" id="btnEliminar">Eliminar</button>
        </div>
      </section>

      <section class="panel">
        <div class="buscar">
          <input type="text" placeholder="Buscar un evento">
          <button class="btn" id="btnBuscarEvento">Buscar</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Evento</th>
              <th>Tipo de evento asignado</th>
            </tr>
          </thead>
          <tbody id="tablaTiposEventos"></tbody>
        </table>
      </section>
    </div>
  </main>
  <script>
// --- 1. MOSTRAR USUARIO LOGUEADO ---
document.addEventListener("DOMContentLoaded", () => {
    // Tu login guarda el nombre completo en la variable "usuario"
    const nombreGuardado = localStorage.getItem("usuario"); 
    
    const elementoNombre = document.getElementById("nombreUsuarioDisplay");
    
    if (elementoNombre) {
        if (nombreGuardado) {
            // Si encontramos el nombre del login, lo ponemos
            elementoNombre.textContent = nombreGuardado.toUpperCase();
        } else {
            // Si no hay login previo, ponemos un default
            elementoNombre.textContent = "COORDINADOR"; 
        }
    }
});

// *** CONFIGURACIN DE ENDPOINTS DE LA API ***
const API_TIPOS_EVENTOS = "http://localhost:3001/api/tipos-eventos"; 
const API_EVENTOS_TIPO = "http://localhost:3001/api/eventos-con-tipo"; 
const API_BUSCAR_EVENTO = "http://localhost:3001/api/eventos-con-tipo/buscar";

// *** REFERENCIAS DEL DOM ***
const inputNombreTipoE = document.querySelector("#nombreTipoEInput"); 
const tablaTiposEventosIzq = document.querySelector("#tablaTipoEvento"); 
const btnCrear = document.querySelector("#btnCrear");
const btnActualizar = document.querySelector("#btnActualizar");
const btnEliminar = document.querySelector("#btnEliminar");
const inputBuscarEvento = document.querySelector(".buscar input[type='text']");
const btnBuscarEvento = document.querySelector("#btnBuscarEvento"); 
const tablaEventosDerecha = document.querySelector("#tablaTiposEventos"); 

let tipoEventoSeleccionadoId = null; 

// Inicializaci贸n de botones
btnActualizar.disabled = true;
btnEliminar.disabled = true;

function actualizarEstadoBotones() {
    if (tipoEventoSeleccionadoId) {
        btnCrear.textContent = "Nuevo"; 
        btnActualizar.disabled = false;
        btnEliminar.disabled = false;
    } else {
        btnCrear.textContent = "Crear"; 
        btnActualizar.disabled = true;
        btnEliminar.disabled = true;
    }
}

// Cargar Panel Izquierdo
async function cargarTiposEventos() {
    try {
        const res = await fetch(API_TIPOS_EVENTOS);
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error("API devolvi贸 茅xito falso.");

        tablaTiposEventosIzq.innerHTML = "";
        data.tiposEventos.forEach(te => {
            const fila = document.createElement("tr");
            fila.innerHTML = `<td>${te.nombre_tipo_eve}</td>`;
            fila.addEventListener("click", () => {
                tipoEventoSeleccionadoId = te.id_tipos_eve;
                inputNombreTipoE.value = te.nombre_tipo_eve; 
                document.querySelectorAll("#tablaTipoEvento tr").forEach(r => r.style.backgroundColor = 'white');
                fila.style.backgroundColor = '#f2f6ff'; 
                actualizarEstadoBotones();
            });
            tablaTiposEventosIzq.appendChild(fila);
        });
    } catch (err) {
        console.error("Fallo al cargar tipos:", err);
    }
}

// Cargar Panel Derecho
async function cargarEventosConTipo() {
    try {
        const res = await fetch(API_EVENTOS_TIPO);
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
        const data = await res.json();
        tablaEventosDerecha.innerHTML = "";
        data.eventos.forEach(e => {
            const fila = document.createElement("tr");
            fila.innerHTML = `<td>${e.nombre_evento}</td><td>${e.nombre_tipo_eve}</td>`;
            tablaEventosDerecha.appendChild(fila);
        });
    } catch (err) {
        console.error("Fallo al cargar eventos:", err);
    }
}

// Buscar
async function buscarEvento() {
    const nombre = inputBuscarEvento.value.trim();
    if (!nombre) {
        cargarEventosConTipo();
        return;
    }
    try {
        const url = `${API_BUSCAR_EVENTO}?nombre=${encodeURIComponent(nombre)}`;
        const res = await fetch(url);
        const data = await res.json();
        tablaEventosDerecha.innerHTML = "";
        data.eventos.forEach(e => {
            const fila = document.createElement("tr");
            fila.innerHTML = `<td>${e.nombre_evento}</td><td>${e.nombre_tipo_eve}</td>`;
            tablaEventosDerecha.appendChild(fila);
        });
    } catch (err) {
        console.error("Fallo al buscar:", err);
    }
}

function limpiarFormulario() {
    tipoEventoSeleccionadoId = null;
    inputNombreTipoE.value = "";
    document.querySelectorAll("#tablaTipoEvento tr").forEach(r => r.style.backgroundColor = 'white');
    actualizarEstadoBotones(); 
}

// Listeners
btnCrear.addEventListener("click", async () => {
    if (tipoEventoSeleccionadoId) {
        limpiarFormulario();
        return;
    }
    const nombreTipoE = inputNombreTipoE.value.trim();
    if (!nombreTipoE) return alert("Completa el nombre.");

    try {
        const res = await fetch(API_TIPOS_EVENTOS, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombreTipoE })
        });
        const data = await res.json();
        if(res.ok) {
            limpiarFormulario();
            cargarTiposEventos();
        } else {
            // Muestra el error si ya existe
            alert(data.message); 
        }
    } catch (error) {
        alert("Error de conexi贸n.");
    }
});

btnActualizar.addEventListener("click", async () => {
    if (!tipoEventoSeleccionadoId) return alert("Selecciona uno primero.");
    const nombreTipoE = inputNombreTipoE.value.trim();
    const res = await fetch(`${API_TIPOS_EVENTOS}/${tipoEventoSeleccionadoId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombreTipoE })
    });
    if(res.ok) {
        limpiarFormulario();
        cargarTiposEventos();
        cargarEventosConTipo(); 
    }
});

btnEliminar.addEventListener("click", async () => {
    if (!tipoEventoSeleccionadoId) return alert("Selecciona uno primero.");
    if (!confirm(`驴Eliminar "${inputNombreTipoE.value}"?`)) return;
    const res = await fetch(`${API_TIPOS_EVENTOS}/${tipoEventoSeleccionadoId}`, { method: "DELETE" });
    if(res.ok) {
        limpiarFormulario();
        cargarTiposEventos();
        cargarEventosConTipo();
    } else {
        alert("Error al eliminar. Puede que est茅 en uso.");
    }
});

btnBuscarEvento.addEventListener("click", buscarEvento);
inputBuscarEvento.addEventListener("keypress", (e) => {
    if (e.key === 'Enter') buscarEvento();
});

// Inicio
cargarTiposEventos();
cargarEventosConTipo();
actualizarEstadoBotones();
</script>
</body>
</html>