<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proyectos</title>
  <link rel="stylesheet" href="css/normalize.css"/>
  <link rel="stylesheet" href="css/estilos.css"/>
  <style>
    body { background:#f1f1f1; margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    header{background:#003366;color:#fff;padding:10px 40px;display:flex;align-items:center;justify-content:space-between}
    header .left{display:flex;align-items:center;gap:15px}
    header img{height:35px}
    header nav a{color:#fff;text-decoration:none;margin-right:20px;font-weight:bold}
    header nav a:hover{text-decoration:underline}
    .contenido{padding:20px 40px}
    h1{text-align:center;color:#003366}

    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #ccc;text-align:left}
    th{background:#aac1e2;color:#003366}

    .botones{display:flex;justify-content:center;gap:12px;margin:22px 0}
    .botones a,.botones button{background:#1e63b5;color:#fff;border:none;border-radius:8px;padding:9px 16px;font-weight:bold;text-decoration:none;cursor:pointer}
    .botones a:hover,.botones button:hover{background:#004b9a}
    .descargar{background:#759fcf}

    /* ðŸ”¹ Panel usuario estilo coordinadora */
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #0a2b57;
      padding: 6px 10px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .user-text {
      font-weight: bold;
      color: #fff;
    }
    .logout-btn {
      background: #c0392b;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    .logout-btn:hover {
      background: #e74c3c;
    }
  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="images/logoITS.png" alt="Logo ITS">
    <span>Instituto TecnolÃ³gico de Saltillo</span>
    <nav>
      <a href="#" id="btnHome">Home</a>
      <a href="proyectos.html">Proyectos</a>
    </nav>
  </div>

  <!-- ðŸ”¹ Panel usuario -->
  <div class="user-info">
    <span class="user-text" id="userName">USUARIO</span>
    <button class="logout-btn" id="logoutBtn" style="display:none;">Cerrar sesiÃ³n</button>
  </div>
</header>

<div class="contenido">
  <h1>PÃ¡gina principal de proyectos</h1>

  <!-- Acciones (crear solo para emprendedor) -->
  <div class="botones">
    <a id="btnCrear" href="crearProyecto.html">Crear nuevo proyecto âž•</a>
    <a class="descargar" href="documentos/Formato_20de_20_Registro.doc" download>Descargar formato de registro</a>
    <a id="btnSeguimiento" href="#">Seguimiento de proyectos</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>TÃ­tulo del proyecto</th>
        <th>Responsable</th>
        <th>Fecha de inicio</th>
        <th>Estatus</th>
        <th>Progreso</th>
      </tr>
    </thead>
  </table>
</div>

<script>
  // Lee el rol desde URL o localStorage
  const params = new URLSearchParams(window.location.search);
  let rol = params.get('rol') || localStorage.getItem('rolUsuario') || 'emprendedor';
  localStorage.setItem('rolUsuario', rol);

  // Mostrar/ocultar "Crear nuevo proyecto" segÃºn rol
  const btnCrear = document.getElementById('btnCrear');
  if (rol === 'coordinador') {
    if (btnCrear) btnCrear.style.display = 'none';
  } else {
    if (btnCrear) btnCrear.style.display = 'inline-block';
  }

  // Seguimiento preservando el rol
  document.getElementById('btnSeguimiento').addEventListener('click', () => {
    window.location.href = `seguimientoProyectos.html?rol=${rol}`;
  });
</script>

<script>
  const btnHome = document.getElementById('btnHome');
  const rolUsuario = localStorage.getItem('rolUsuario');

  if (btnHome) {
    btnHome.addEventListener('click', e => {
      e.preventDefault();
      if (rolUsuario === 'coordinador') {
        window.location.href = 'inicioC.html';
      } else {
        window.location.href = 'inicioE.html';
      }
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const id_usuario = localStorage.getItem("id_usuario");
    const tipo = (localStorage.getItem("tipo") || "").toLowerCase();

    if (!id_usuario) {
      alert("Debes iniciar sesiÃ³n para ver tus proyectos.");
      window.location.href = "login.html";
      return;
    }

    // ðŸ”¹ Mostrar nombre del usuario y botÃ³n cerrar sesiÃ³n
    const nombre = localStorage.getItem("nombre");
    const apellido = localStorage.getItem("apellido");
    const correo = localStorage.getItem("correo");
    const userNameSpan = document.getElementById("userName");
    const logoutBtn = document.getElementById("logoutBtn");

    if (nombre) {
      userNameSpan.textContent = `${nombre} ${apellido || ""}`.trim();
      logoutBtn.style.display = "inline-block";
    } else {
      userNameSpan.textContent = correo || "Invitado";
      logoutBtn.style.display = "none";
    }

    logoutBtn.addEventListener("click", () => {
      if (confirm("Â¿Deseas cerrar sesiÃ³n?")) {
        localStorage.clear();
        alert("SesiÃ³n cerrada correctamente.");
        window.location.href = "login.html";
      }
    });

    // ðŸ”¹ Cargar proyectos (si coordinador = todos; si emprendedor = solo los suyos)
    try {
      const endpoint =
        tipo === "coordinador"
          ? `http://localhost:3001/api/proyectos/${id_usuario}?rol=coordinador`
          : `http://localhost:3001/api/proyectos/${id_usuario}`;

      console.log("ðŸ“¡ Cargando proyectos desde:", endpoint);
      const res = await fetch(endpoint);
      const data = await res.json();

      const tabla = document.querySelector("table");
      const tbody = document.createElement("tbody");

      if (!data || data.length === 0) {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td colspan="5" style="text-align:center;color:#555;">No hay proyectos registrados.</td>`;
        tbody.appendChild(fila);
      } else {
        data.forEach(p => {
          const responsable = p.responsable
            ? `${p.responsable} ${p.responsable_apellido || ""}`.trim()
            : (nombre + " " + apellido).trim() || "TÃº";

          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${p.nombre_proyecto}</td>
            <td>${responsable}</td>
            <td>${p.fecha_inicio ? new Date(p.fecha_inicio).toLocaleDateString() : "-"}</td>
            <td>${p.estatus}</td>
            <td>${p.progreso}</td>
          `;
          tbody.appendChild(fila);
        });
      }

      tabla.appendChild(tbody);
    } catch (err) {
      console.error("Error al cargar proyectos:", err);
    }
  });
</script>

</body>
</html>
