<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Emprendurismo ITS</title>
    <link rel="shortcut icon" href="./images/logoITS.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./css/estilos.css">
</head>
<body>

    <header class="navbar">
        <div class="container nav-content">
            <div class="logo">
                <img src="./images/logoITS.png" alt="ITS" />
                <span>Instituto Tecnológico de Saltillo</span>
            </div>

            <div class="user-info">
                <span class="user-text">USUARIO</span>
                <div class="user-icon">👤</div>
            </div>
        </div>
        <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #f3f4f6;
      color: #001d3d;
    }

    /* NAVBAR */
.navbar {
    background: #003366;
    color: #fff;
    height: 50px; /* define altura fija */
    display: flex;
    align-items: center; /* centra verticalmente el contenido */
}

.nav-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 90%;
    margin: 0 auto;
}

.logo {
    display: flex;
    align-items: center;
}

.logo img {
    width: 30px; /* tamaño del icono reducido */
    height: 30px;
    margin-right: 8px;
}

.nav-right {
    font-weight: bold;
    font-size: 14px;
}

    /* Contenido */
    .container {
      padding: 40px;
    }

    .container h2 {
      color: #001d3d;
      font-size: 24px;
      margin-bottom: 20px;
    }

    .paneles {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }

    .panel {
      background-color: #dbe7ff;
      flex: 1;
      border-radius: 10px;
      padding: 25px;
      min-width: 300px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 10px;
    }

    input[type="text"], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 5px;
      margin-bottom: 15px;
    }

    /* Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #e0ebff;
      font-weight: 600;
    }

    tr:hover {
      background-color: #f2f6ff;
    }

    /* Botones */
    .botones {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      background-color: #003366;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      flex: 1;
      min-width: 120px;
    }

    .btn:hover {
      background-color: #001f54;
    }

    /* Sección buscar */
    .buscar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .paneles {
        flex-direction: column;
      }

      .botones {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
    </header>
    
    <div class="main-content role-management-view">
        <div class="form-container">
            <header>
                <h2>Gestión de Roles</h2>
            </header>
            
            <div class="paneles">
      <!-- Panel izquierdo -->
      <section class="panel">
        <label>Nombre del rol</label>
        <input type="text" id="nombreRolInput" placeholder="Nombre del rol">

        <label>Permisos del rol:</label>
        <select id="selectPermiso">
          <option>Seleccione el permiso</option>
          <option>Administrador</option>
          <option>Usuario</option>
        </select>

        <h3>Roles creados</h3>
        <table>
          <thead>
            <tr>
              <th>Nombre del Rol</th>
              <th>Permiso</th>
            </tr>
          </thead>
          <tbody id="tablaRoles">
            </tbody>
        </table>

        <div class="botones">
          <button class="btn" id="btnCrear">Crear rol</button>
          <button class="btn" id="btnActualizar">Actualizar rol</button>
          <button class="btn" id="btnEliminar">Eliminar rol</button>
        </div>
      </section>

      <!-- Panel derecho -->
      <section class="panel">
        <div class="buscar">
          <input type="text" placeholder="Buscar un usuario">
          <button class="btn">Buscar</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Rol asignado</th>
            </tr>
          </thead>
          <tbody id="tablaUsuariosRol">
          </tbody>
        </table>
      </section>
    </div>
  </main>
  <script>
const API_URL = "http://localhost:3001/api/roles"; // ¡Ruta corregida!
const tablaRoles = document.querySelector("#tablaRoles"); 
const inputNombre = document.querySelector("#nombreRolInput");
const selectPermiso = document.querySelector("#selectPermiso");
const btnCrear = document.querySelector("#btnCrear");
const btnActualizar = document.querySelector("#btnActualizar");
const btnEliminar = document.querySelector("#btnEliminar");
let rolSeleccionadoId = null;

// Función para inicializar el ComboBox de Permisos
function cargarPermisos(permisos) {
    selectPermiso.innerHTML = '<option value="">Seleccione el permiso</option>';
    permisos.forEach(permiso => {
        const option = document.createElement("option");
        option.value = permiso;
        option.textContent = permiso;
        selectPermiso.appendChild(option);
    });
}

// Función principal para cargar la tabla de roles
async function cargarRoles() {
    try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
        
        const data = await res.json();
        
        if (!data.success) throw new Error("API devolvió éxito falso.");

        // 1. Llenar el ComboBox de Permisos (solo en la primera carga)
        if (data.permisosDisponibles && selectPermiso.options.length <= 1) {
            cargarPermisos(data.permisosDisponibles);
        }

        // 2. Llenar la Tabla de Roles
        tablaRoles.innerHTML = "";
        data.roles.forEach(rol => {
            const fila = document.createElement("tr");
            
            // Asegúrate que Nombre_Rol y Permisos coincidan con tu DB
            fila.innerHTML = `<td>${rol.Nombre_Rol}</td><td>${rol.Permisos}</td>`;
            
            fila.addEventListener("click", () => {
                // Al hacer clic, selecciona el rol para edición/eliminación
                rolSeleccionadoId = rol.id_Rol;
                inputNombre.value = rol.Nombre_Rol;
                selectPermiso.value = rol.Permisos;
                
                // Efecto visual: deseleccionar todas y seleccionar la clicada
                document.querySelectorAll("#tablaRoles tr").forEach(r => r.style.backgroundColor = 'white');
                fila.style.backgroundColor = '#f2f6ff'; // Estilo de hover
            });
            tablaRoles.appendChild(fila);
        });
        
    } catch (err) {
        console.error("Fallo al cargar roles:", err);
        alert("No se pudieron cargar los roles. Revisa la consola y el servidor.");
    }
}

const API_USUARIOS_ROL = "http://localhost:3001/api/usuarios-con-rol";
const tablaUsuariosRol = document.querySelector("#tablaUsuariosRol");

// Cargar usuarios con su rol
async function cargarUsuariosConRol() {
    try {
        const res = await fetch(API_USUARIOS_ROL);
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);

        const data = await res.json();
        if (!data.success) throw new Error("La API devolvió un error.");

        tablaUsuariosRol.innerHTML = "";
        data.usuarios.forEach(u => {
            const fila = document.createElement("tr");
            fila.innerHTML = `<td>${u.Usuario}</td><td>${u.Nombre_Rol}</td>`;
            tablaUsuariosRol.appendChild(fila);
        });
    } catch (err) {
        console.error("Fallo al cargar usuarios con rol:", err);
    }
}

// Limpia el formulario después de una operación
function limpiarFormulario() {
    rolSeleccionadoId = null;
    inputNombre.value = "";
    selectPermiso.value = ""; // Vuelve al 'Seleccione el permiso'
    document.querySelectorAll("#tablaRoles tr").forEach(r => r.style.backgroundColor = 'white');
}

// --- Event Listeners para el CRUD ---

btnCrear.addEventListener("click", async () => {
    const nombreRol = inputNombre.value;
    const permisos = selectPermiso.value;

    if (!nombreRol || !permisos) return alert("Completa el nombre y selecciona un permiso.");

    await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombreRol, permisos })
    });
    limpiarFormulario();
    cargarRoles();
});

btnActualizar.addEventListener("click", async () => {
    if (!rolSeleccionadoId) return alert("Selecciona un rol primero.");
    
    const nombreRol = inputNombre.value;
    const permisos = selectPermiso.value;

    if (!nombreRol || !permisos) return alert("Completa el nombre y selecciona un permiso.");

    await fetch(`${API_URL}/${rolSeleccionadoId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombreRol, permisos })
    });
    limpiarFormulario();
    cargarRoles();
});

btnEliminar.addEventListener("click", async () => {
    if (!rolSeleccionadoId) return alert("Selecciona un rol primero.");
    
    // Opcional: Confirmación de eliminación
    if (!confirm("¿Estás seguro de que quieres eliminar este rol?")) return;

    await fetch(`${API_URL}/${rolSeleccionadoId}`, { method: "DELETE" });
    
    limpiarFormulario();
    cargarRoles();
});

// Carga inicial
cargarRoles();
cargarUsuariosConRol();
</script>
</body>
</html>