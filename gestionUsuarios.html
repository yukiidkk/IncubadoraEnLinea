<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti贸n de Usuarios - Incubadora ITS</title>
  <link rel="shortcut icon" href="./images/logoITS.png" type="image/x-icon">
  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/estilos.css">

  <style>
    body {
      background: #eaf2ff;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
      background: #003366;
      color: #fff;
      padding: 10px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      height: 40px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #0a2b57;
      padding: 6px 10px;
      border-radius: 10px;
    }

    .user-text {
      font-weight: bold;
      color: #fff;
    }

    .home-btn, .logout-btn {
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      transition: background 0.2s;
    }

    .home-btn { background: #0066cc; }
    .home-btn:hover { background: #0052a3; }

    .logout-btn { background: #c0392b; }
    .logout-btn:hover { background: #a83224; }

    .form-container.user-management-container {
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 25px 30px;
      border-radius: 10px;
      background: #fff;
      max-width: 1100px;
      margin: 30px auto;
    }

    header h2 {
      color: #003366;
      margin-bottom: 5px;
    }

    header p {
      color: #444;
      margin-top: 0;
      font-size: 14px;
    }

    .search-bar {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0;
      margin: 20px 0;
      border: none;
      box-shadow: none;
    }

    .search-bar input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px 0 0 6px;
      outline: none;
      font-size: 15px;
    }

    .search-bar .btn-search {
      background: #003366;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s ease;
    }

    .search-bar .btn-search:hover {
      background: #0055cc;
    }

    .suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      width: calc(100% - 2px);
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
    }

    .suggestion-item {
      padding: 8px;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background: #e3ecff;
    }

    .columns-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      font-weight: 600;
      color: #003366;
      display: block;
      margin-bottom: 5px;
    }

    .form-group input, 
    .form-group select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    .inline-group {
      display: flex;
      gap: 10px;
    }

    .form-actions {
      text-align: center;
      margin-top: 30px;
    }

    .btn-primary-its, .btn-secondary-its, .btn-delete-its {
      background: #003366;
      color: #fff;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.2s ease, transform 0.1s ease;
      margin: 0 10px;
      font-weight: bold;
    }

    .btn-primary-its:hover, 
    .btn-secondary-its:hover, 
    .btn-delete-its:hover {
      transform: scale(1.05);
    }

    .btn-primary-its { background: #006400; }
    .btn-primary-its:hover { background: #008000; }

    .btn-secondary-its { background: #003366; }
    .btn-secondary-its:hover { background: #004499; }

    .btn-delete-its { background: #a30000; }
    .btn-delete-its:hover { background: #cc0000; }

  </style>
</head>

<body>
  <header class="navbar">
    <div class="logo">
      <img src="./images/logoITS.png" alt="ITS" />
      <span>Instituto Tecnol贸gico de Saltillo</span>
    </div>
    <div class="user-info">
      <button class="home-btn" id="homeBtn">Inicio</button>
      <span class="user-text" id="userName">USUARIO</span>
      <div class="user-icon"></div>
      <button class="logout-btn" id="logoutBtn" style="display:none;">Cerrar sesi贸n</button>
    </div>
  </header>

  <div class="form-container user-management-container">
    <header>
      <h2>Gesti贸n de Usuarios</h2>
      <p>Busca, crea o actualiza usuarios registrados en el sistema.</p>
    </header>

    <div class="search-bar">
      <input type="text" placeholder="Buscar usuario por nombre, apellido o correo">
      <button type="button" class="btn-search">Buscar</button>
    </div>

    <form class="account-form user-management-form">
      <div class="columns-wrapper">
        <div class="column">
          <div class="form-group"><label>Nombre(s):</label><input type="text" id="nombre"></div>
          <div class="form-group"><label>Apellidos:</label><input type="text" id="apellido"></div>
          <div class="form-group"><label>Tel茅fono:</label><input type="tel" id="telefono"></div>
          <div class="form-group"><label>Fecha de nacimiento:</label><input type="date" id="fecha_nacimiento"></div>
          <div class="form-group"><label>Correo electr贸nico:</label><input type="email" id="correo"></div>
          <div class="form-group"><label>Ingresos mensuales:</label><input type="number" id="ingresos"></div>
          <div class="form-group"><label>Dependientes econ贸micos:</label>
            <select id="dependientes_eco">
              <option value="">Seleccione</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3 o m谩s</option>
            </select>
          </div>
          <div class="form-group"><label>Contrase帽a:</label><input type="password" id="contrasena"></div>
        </div>

        <div class="column">
          <div class="form-group"><label>RFC:</label><input type="text" id="rfc"></div>
          <div class="form-group"><label>CURP:</label><input type="text" id="curp"></div>
          <div class="form-group">
            <label>Estado civil y g茅nero:</label>
            <div class="inline-group">
              <select id="estado_civil"></select>
              <select id="genero"></select>
            </div>
          </div>
          <div class="form-group">
            <label>Domicilio:</label>
            <div class="inline-group">
              <input type="text" id="colonia" placeholder="Colonia">
              <input type="text" id="cp" placeholder="C.P.">
            </div>
            <input type="text" id="calle" placeholder="Calle">
          </div>
          <div class="form-group"><label>Jornada:</label><select id="jornada"></select></div>
          <div class="form-group"><label>N煤mero de control:</label><input type="text" id="no_control"></div>
          <div class="form-group"><label>Especialidad:</label><select id="id_especialidad"></select></div>
          <div class="form-group"><label>Rol:</label><select id="id_rol"></select></div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary-its" value="create">Crear usuario</button>
        <button type="button" class="btn-secondary-its" value="update">Actualizar</button>
        <button type="button" class="btn-delete-its" value="delete">Eliminar</button>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const nombre = localStorage.getItem("nombre");
      const apellido = localStorage.getItem("apellido");
      const userNameSpan = document.getElementById("userName");
      const logoutBtn = document.getElementById("logoutBtn");
      const homeBtn = document.getElementById("homeBtn");

      if (nombre) {
        userNameSpan.textContent = `${nombre} ${apellido || ""}`.trim();
        logoutBtn.style.display = "inline-block";
      } else {
        userNameSpan.textContent = "Invitado";
      }

      logoutBtn.addEventListener("click", () => {
        if (confirm("驴Deseas cerrar sesi贸n?")) {
          localStorage.clear();
          alert("Sesi贸n cerrada correctamente.");
          window.location.href = "login.html";
        }
      });

      homeBtn.addEventListener("click", () => window.location.href = "inicioC.html");

      const sendRequest = async (url, method = "GET", body = null) => {
        try {
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: body ? JSON.stringify(body) : null,
          });
          return await res.json();
        } catch (err) {
          console.error("Error:", err);
          alert("Error de conexi贸n con el servidor.");
        }
      };

      const mapUser = (u) => ({
        id_persona: u.id_persona ?? u.Id_Persona ?? null,
        nombre: u.nombre ?? u.Nombre ?? "",
        apellido: u.apellido ?? u.Apellido ?? "",
        telefono: u.telefono ?? u.Telefono ?? "",
        fecha_nacimiento: u.fecha_nacimiento ?? u.Fecha_Nacimiento ?? "",
        correo: u.correo ?? u.Correo ?? "",
        ingresos: u.ingresos ?? u.Ingresos ?? "",
        dependientes_eco: u.dependientes_eco ?? u.Dependientes_Eco ?? "",
        rfc: u.rfc ?? u.RFC ?? "",
        curp: u.curp ?? u.CURP ?? "",
        estado_civil: u.estado_civil ?? u.Estado_Civil ?? "",
        genero: u.genero ?? u.Genero ?? "",
        colonia: u.colonia ?? u.Colonia ?? "",
        cp: (u.cp ?? u.CP ?? "").toString(),
        calle: u.calle ?? u.Calle ?? "",
        jornada: u.jornada ?? u.Jornada ?? "",
        no_control: u.no_control ?? u.No_Control ?? "",
        id_especialidad: u.id_especialidad ?? u.Id_Especialidad ?? "",
        id_rol: u.id_rol ?? u.Id_Rol ?? ""
      });

      const setSelectValue = (sel, val) => {
        if (!sel || !val) return;
        val = val.toString().trim().toLowerCase();
        for (const opt of sel.options)
          if (opt.value.toLowerCase() === val || opt.textContent.toLowerCase() === val) {
            sel.value = opt.value;
            return;
          }
        const o = document.createElement("option");
        o.value = val;
        o.textContent = val;
        sel.appendChild(o);
        sel.value = val;
      };

      const toISODate = (f) => {
        if (!f) return "";
        if (f.includes("T")) return f.split("T")[0];
        if (f.includes("/")) {
          const [mm, dd, yy] = f.split("/");
          return `${yy}-${mm}-${dd}`;
        }
        return f;
      };

      const cargarCombos = async () => {
        try {
          const esp = await sendRequest("http://localhost:3001/api/usuarios/especialidades");
          const eSel = document.querySelector("#id_especialidad");
          eSel.innerHTML = '<option value="">Seleccione</option>';
          esp.forEach(e => {
            const o = document.createElement("option");
            o.value = e.id_especialidad;
            o.textContent = e.nombre_especialidad;
            eSel.appendChild(o);
          });

          const rolRes = await sendRequest("http://localhost:3001/api/roles");
          const roles = rolRes.roles || rolRes;
          const rSel = document.querySelector("#id_rol");
          rSel.innerHTML = '<option value="">Seleccione rol</option>';
          roles.forEach(r => {
            const o = document.createElement("option");
            o.value = r.id_rol;
            o.textContent = r.nombre_rol;
            rSel.appendChild(o);
          });

          const gen = await sendRequest("http://localhost:3001/api/usuarios/generos");
          const gSel = document.querySelector("#genero");
          gSel.innerHTML = '<option value="">Seleccione g茅nero</option>';
          gen.forEach(g => {
            const o = document.createElement("option");
            o.value = g;
            o.textContent = g;
            gSel.appendChild(o);
          });

          const est = await sendRequest("http://localhost:3001/api/usuarios/estados-civiles");
          const eCiv = document.querySelector("#estado_civil");
          eCiv.innerHTML = '<option value="">Seleccione estado civil</option>';
          est.forEach(e => {
            const o = document.createElement("option");
            o.value = e;
            o.textContent = e;
            eCiv.appendChild(o);
          });

          const jor = await sendRequest("http://localhost:3001/api/usuarios/jornadas");
          const jSel = document.querySelector("#jornada");
          jSel.innerHTML = '<option value="">Seleccione jornada</option>';
          jor.forEach(j => {
            const o = document.createElement("option");
            o.value = j;
            o.textContent = j;
            jSel.appendChild(o);
          });
        } catch (e) { console.error(e); }
      };

      const combosReady = cargarCombos();

      const searchInput = document.querySelector(".search-bar input");
      const suggestions = document.createElement("div");
      suggestions.classList.add("suggestions");
      document.querySelector(".search-bar").appendChild(suggestions);

      searchInput.addEventListener("input", async () => {
        const q = searchInput.value.trim();
        if (q.length < 2) { suggestions.innerHTML = ""; return; }
        const raw = await sendRequest(`http://localhost:3001/api/usuarios/buscar?nombre=${q}`);
        const users = (raw || []).map(mapUser);
        suggestions.innerHTML = "";
        if (!users.length) {
          suggestions.innerHTML = "<div class='suggestion-item'>No se encontraron usuarios</div>";
          return;
        }
        users.forEach(u => {
          const item = document.createElement("div");
          item.classList.add("suggestion-item");
          item.textContent = `${u.nombre} ${u.apellido}`.trim();
          item.onclick = () => { fillUserForm(u); suggestions.innerHTML = ""; searchInput.value = ""; };
          suggestions.appendChild(item);
        });
      });

      const fillUserForm = (u) => {
        const user = mapUser(u);
        combosReady.then(() => {
          document.querySelector("#nombre").value = user.nombre;
          document.querySelector("#apellido").value = user.apellido;
          document.querySelector("#telefono").value = user.telefono;
          document.querySelector("#fecha_nacimiento").value = toISODate(user.fecha_nacimiento);
          document.querySelector("#correo").value = user.correo;
          document.querySelector("#ingresos").value = user.ingresos;
          document.querySelector("#dependientes_eco").value = user.dependientes_eco;
          document.querySelector("#rfc").value = user.rfc;
          document.querySelector("#curp").value = user.curp;
          document.querySelector("#colonia").value = user.colonia;
          document.querySelector("#cp").value = user.cp;
          document.querySelector("#calle").value = user.calle;
          document.querySelector("#no_control").value = user.no_control;
          setSelectValue(document.querySelector("#estado_civil"), user.estado_civil);
          setSelectValue(document.querySelector("#genero"), user.genero);
          setSelectValue(document.querySelector("#jornada"), user.jornada);
          setSelectValue(document.querySelector("#id_especialidad"), user.id_especialidad);
          setSelectValue(document.querySelector("#id_rol"), user.id_rol);
          searchInput.dataset.userId = user.id_persona;
        });
      };

      const getFormData = () => ({
        nombre: document.querySelector("#nombre").value,
        apellido: document.querySelector("#apellido").value,
        telefono: document.querySelector("#telefono").value,
        fecha_nacimiento: document.querySelector("#fecha_nacimiento").value,
        correo: document.querySelector("#correo").value,
        ingresos: document.querySelector("#ingresos").value,
        dependientes_eco: document.querySelector("#dependientes_eco").value,
        rfc: document.querySelector("#rfc").value,
        curp: document.querySelector("#curp").value,
        estado_civil: document.querySelector("#estado_civil").value,
        genero: document.querySelector("#genero").value,
        colonia: document.querySelector("#colonia").value,
        cp: document.querySelector("#cp").value,
        calle: document.querySelector("#calle").value,
        jornada: document.querySelector("#jornada").value,
        no_control: document.querySelector("#no_control").value,
        id_especialidad: document.querySelector("#id_especialidad").value,
        id_rol: document.querySelector("#id_rol").value,
        contrasena: document.querySelector("#contrasena").value
      });

      document.querySelector("button[value='create']").addEventListener("click", async e => {
        e.preventDefault();
        const res = await sendRequest("http://localhost:3001/api/usuarios", "POST", getFormData());
        if (res?.message) alert(res.message);
      });

      document.querySelector("button[value='update']").addEventListener("click", async e => {
        e.preventDefault();
        const id = searchInput.dataset.userId;
        if (!id) return alert("Selecciona un usuario primero.");
        const res = await sendRequest(`http://localhost:3001/api/usuarios/${id}`, "PUT", getFormData());
        if (res?.message) alert(res.message);
      });

      document.querySelector("button[value='delete']").addEventListener("click", async e => {
        e.preventDefault();
        const id = searchInput.dataset.userId;
        if (!id) return alert("Selecciona un usuario primero.");
        if (!confirm("驴Seguro que deseas eliminar este usuario?")) return;
        const res = await sendRequest(`http://localhost:3001/api/usuarios/${id}`, "DELETE");
        if (res?.message) alert(res.message);
      });
    });
  </script>
</body>
</html>
