<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listas de Asistencia - ITS</title>
  <style>
    /* --- ESTILOS GLOBALES --- */
    * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; }
    body { background-color: #f3f4f6; color: #001d3d; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column;}

    /* NAVBAR */
    header { background-color: #003366; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
    header .logo { display: flex; align-items: center; font-weight: 600; font-size: 16px; gap: 10px; }
    header .logo img { height: 28px; border-radius: 4px; }
    nav { display: flex; gap: 20px; }
    nav a { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; font-size: 14px; padding: 8px 12px; border-radius: 6px; transition: 0.3s; }
    nav a:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
    .usuario { display: flex; align-items: center; font-weight: bold; font-size: 14px; gap: 10px; }
    .avatar { width: 32px; height: 32px; background-color: #e0ebff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #003366; font-size: 13px; }

    /* LAYOUT DE 2 COLUMNAS */
    .container { 
        display: grid; 
        /* Izquierda fija (350px), Derecha flexible (resto) */
        grid-template-columns: 350px 1fr; 
        gap: 25px; 
        padding: 30px 40px; 
        max-width: 1600px; 
        margin: 0 auto; 
        flex: 1; 
        overflow: hidden; 
        width: 100%;
    }
    
    .panel { 
        background-color: white; 
        padding: 20px; 
        border-radius: 10px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        border: 1px solid #e0e0e0; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
    }

    h2 { 
        color: #003366; 
        margin: 0 0 15px 0; 
        font-size: 18px; 
        border-bottom: 2px solid #f0f0f0; 
        padding-bottom: 10px; 
        font-weight: 700;
    }

    /* SCROLL */
    .scroll-area { 
        flex: 1; 
        overflow-y: auto; 
        padding-right: 5px; 
    }
    .scroll-area::-webkit-scrollbar { width: 6px; }
    .scroll-area::-webkit-scrollbar-track { background: #f1f1f1; }
    .scroll-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    /* TARJETAS DE EVENTO (Lado Izquierdo) */
    .event-card { 
        display: flex; 
        flex-direction: column; 
        gap: 5px; 
        margin-bottom: 10px; 
        background-color: #fff; 
        padding: 12px 15px; 
        border-radius: 8px; 
        border: 1px solid #eee; 
        cursor: pointer; 
        transition: all 0.2s; 
    }
    .event-card:hover { 
        background-color: #f8fbff; 
        border-color: #003366; 
        transform: translateY(-2px); 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .event-card.selected { 
        background-color: #003366; 
        color: white; 
        border-color: #003366; 
    }
    .event-card.selected strong { color: white; }
    .event-card.selected small { color: #ccc; }

    .event-card strong { display: block; font-size: 15px; color: #001d3d; margin-bottom: 4px; }
    .event-card small { color: #666; font-size: 12px; display: flex; justify-content: space-between; }

    /* BUSCADOR */
    .search-box { display: flex; margin-bottom: 15px; }
    .search-box input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px 0 0 6px; outline: none; font-size: 13px; }
    .search-box button { border-radius: 0 6px 6px 0; background-color: #003366; padding: 0 15px; color: white; border: none; cursor: pointer; }

    /* LISTA DE ALUMNOS (Lado Derecho) */
    .student-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 15px; 
        border-bottom: 1px solid #f0f0f0; 
        font-size: 15px; 
    }
    .student-item:hover { background-color: #fafafa; }
    .student-item:last-child { border-bottom: none; }
    
    .student-name { font-weight: 600; color: #333; font-size: 16px; }
    .student-meta { font-size: 13px; color: #777; margin-top: 3px; }
    
    .student-control { 
        background: #e0ebff; 
        color: #003366; 
        padding: 6px 12px; 
        border-radius: 6px; 
        font-family: monospace; 
        font-size: 14px; 
        font-weight: bold; 
        letter-spacing: 0.5px;
    }

    /* HEADER DEL CENTRO */
    .info-header {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .info-title { font-size: 20px; font-weight: bold; color: #003366; }
    
    .status-badge {
        display: inline-block; padding: 6px 12px; border-radius: 20px;
        font-size: 12px; font-weight: bold; color: white; text-transform: uppercase;
    }
    .bg-green { background-color: #4caf50; }
    .bg-red { background-color: #f44336; }
    .bg-blue { background-color: #003366; }

    @media (max-width: 900px) { .container { grid-template-columns: 1fr; overflow-y: auto; } .panel { min-height: 400px; } }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="./images/logoITS.png" alt="ITS" onerror="this.style.display='none'">
      Instituto Tecnológico de Saltillo
    </div>
    <nav>
      <a href="inicioC.html">Inicio</a>
      <a href="tipos_evento.html">Tipos Evento</a>
      <a href="#" style="background: rgba(255,255,255,0.2);">Inscritos</a>
    </nav>
    <div class="usuario">
      <div class="avatar">A</div>
      <span id="user-name">ADMIN</span>
    </div>
  </header>

  <div class="container">
    
    <div class="panel">
      <h2>Seleccionar Evento</h2>
      <div class="search-box">
        <input type="text" id="search-left" placeholder="Buscar evento...">
        <button></button>
      </div>
      <div id="lista-izq" class="scroll-area">
        <p style="color:#888; text-align:center; padding:20px;">Cargando...</p>
      </div>
    </div>

    <div class="panel">
      <h2 style="border-bottom-color: #003366;"> Lista de Asistencia</h2>
      
      <div id="info-evento-seleccionado" class="info-header" style="display:none;">
        <div>
            <span style="display:block; font-size:12px; color:#666; margin-bottom:4px;">EVENTO SELECCIONADO:</span>
            <span class="info-title" id="titulo-evento-centro">Evento</span>
        </div>
        <span id="badge-cupo" class="status-badge bg-blue">Cupo: -/-</span>
      </div>

      <div id="lista-alumnos" class="scroll-area">
        <div style="text-align:center; padding:60px; color:#888;">
          <div style="font-size:40px; margin-bottom:15px; opacity:0.3;"></div>
          <p style="font-size:16px;">Selecciona un evento de la izquierda<br>para ver a los alumnos inscritos.</p>
        </div>
      </div>
    </div>

  </div>

<script>
const API_URL = 'http://localhost:3001/api';

document.addEventListener("DOMContentLoaded", () => {
    const usuario = localStorage.getItem("usuario");
    if(usuario) document.getElementById("user-name").textContent = usuario.toUpperCase();
    cargarEventos();
});

let todosLosEventos = [];

async function cargarEventos() {
    try {
        const res = await fetch(`${API_URL}/eventos`);
        const data = await res.json();
        todosLosEventos = Array.isArray(data) ? data : [];
        renderizarEventos();
    } catch (error) {
        console.error(error);
        document.getElementById("lista-izq").innerHTML = '<p style="color:red; text-align:center;">Error de conexión.</p>';
    }
}

function renderizarEventos() {
    const listaIzq = document.getElementById("lista-izq");
    listaIzq.innerHTML = "";

    if (todosLosEventos.length === 0) {
        listaIzq.innerHTML = '<p style="text-align:center; color:#888;">Sin registros.</p>';
        return;
    }

    todosLosEventos.forEach(evento => {
        // Procesar fecha para mostrar bonito
        const fechaBD = new Date(evento.fecha_evento);
        const fechaVisual = new Date(fechaBD.getTime() + fechaBD.getTimezoneOffset() * 60000);
        const fechaBonita = fechaVisual.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });

        const inscritos = evento.inscritos || 0;
        const cupo = evento.cupo || 0;
        const lleno = inscritos >= cupo;
        const colorEstado = lleno ? "#f44336" : "#4caf50"; 
        const textoEstado = lleno ? "LLENO" : "DISPONIBLE";

        const cardHTML = `
            <div class="event-card" onclick="cargarAlumnos(${evento.id_evento}, '${evento.nombre_evento}', ${inscritos}, ${cupo}, this)">
                <strong>${evento.nombre_evento}</strong>
                <small>
                    <span> ${fechaBonita}</span>
                    <span style="color:${colorEstado}; font-weight:bold;">${textoEstado} (${inscritos}/${cupo})</span>
                </small>
            </div>
        `;
        listaIzq.insertAdjacentHTML('beforeend', cardHTML);
    });
}

async function cargarAlumnos(idEvento, nombreEvento, inscritos, cupo, cardElement) {
    // Resaltar tarjeta seleccionada
    document.querySelectorAll('.event-card').forEach(el => el.classList.remove('selected'));
    if(cardElement) cardElement.classList.add('selected');

    // Mostrar Header con info
    const headerInfo = document.getElementById("info-evento-seleccionado");
    headerInfo.style.display = "flex"; // Flex para que se separen título y cupo
    document.getElementById("titulo-evento-centro").textContent = nombreEvento;
    
    const badge = document.getElementById("badge-cupo");
    badge.textContent = `Inscritos: ${inscritos} / ${cupo}`;
    
    if (inscritos >= cupo) {
        badge.className = "status-badge bg-red";
    } else {
        badge.className = "status-badge bg-green";
    }

    const listaContainer = document.getElementById("lista-alumnos");
    listaContainer.innerHTML = '<p style="text-align:center; padding:40px; color:#666;">Cargando lista de asistencia...</p>';

    try {
        const res = await fetch(`${API_URL}/inscripciones/evento/${idEvento}`);
        const alumnos = await res.json();
        const listaLimpia = Array.isArray(alumnos) ? alumnos : [];

        listaContainer.innerHTML = "";

        if (listaLimpia.length === 0) {
            listaContainer.innerHTML = `
                <div style="text-align:center; padding:60px; color:#888;">
                    <div style="font-size:30px; margin-bottom:10px;"></div>
                    <p style="font-size:16px;">Nadie se ha inscrito a este evento todavía.</p>
                </div>`;
            return;
        }

        listaLimpia.forEach((alu, index) => {
            const div = document.createElement("div");
            div.className = "student-item";
            // Agregamos un número de lista para que se vea más pro
            div.innerHTML = `
                <div style="display:flex; gap:15px; align-items:center;">
                    <span style="color:#999; font-weight:bold; width:20px;">${index + 1}.</span>
                    <div>
                        <div class="student-name">${alu.nombre} ${alu.apellido}</div>
                        <div class="student-meta"> ${alu.correo}</div>
                    </div>
                </div>
                <div class="student-control">NC: ${alu.no_control || 'S/N'}</div>
            `;
            listaContainer.appendChild(div);
        });

    } catch (error) {
        console.error(error);
        listaContainer.innerHTML = '<p style="color:red; text-align:center; padding:40px;">Error al cargar los datos del servidor.</p>';
    }
}

// Buscador
document.getElementById("search-left").addEventListener("keyup", (e) => {
    const texto = e.target.value.toLowerCase();
    document.querySelectorAll("#lista-izq .event-card").forEach(card => {
        const titulo = card.querySelector("strong").textContent.toLowerCase();
        card.style.display = titulo.includes(texto) ? "flex" : "none";
    });
});
</script>
</body>
</html>