<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorías - Coordinador</title>
    <link rel="stylesheet" href="css/disponibilidad.css">
</head>
<body>
<!-- ALERTA -->
    <div id="alerta"></div>

    <!-- ENCABEZADO -->
    <header class="header">
        <div class="logo">
            <img src="../images/logoITS.png" alt="Logo" class="logo-img">
            <span>Instituto Tecnológico de Saltillo</span>
        </div>
        <nav class="nav">
            <a href="../inicioC.html">Inicio</a>
            <a href="../gestionUsuarios.html">Usuarios</a>
            <a href="../roles.html">Roles</a>
            <a href="../proyectos.html">Proyectos</a>
            <a href="../reportes.html">Reportes</a>
            <a href="../eventos.html">Eventos</a>
            <a href="tutorias.html">Tutorias</a>
        </nav>
        <div class="usuario">
            <span>Coordinador</span>
            <img src="../images/user-icon.png" alt="usuario" class="usuario-img" width="25" height="25">
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container">
        <!-- MENÚ LATERAL -->
        <aside class="sidebar">
            <h3>Menú</h3>
            <ul>
                <li><a href="tutorias.html">Agenda</a></li>
                <li><a href="#" class="active">Disponibilidad</a></li>
                <!-- <li><a href="historial.html">Historial</a></li> -->
            </ul>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main">
            <h2>Tutorías</h2>
            <h3>Disponibilidad</h3>

            <!-- CONTENEDOR DE CALENDARIO Y FORMULARIO -->
            <div class="content-wrapper">
                <!-- CALENDARIO -->
                <div class="calendario-container">
                    <div class="calendar">
                        <input type="month" id="mes" value="2023-01">
                        <div class="calendar-box">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Dom</th>
                                        <th>Lun</th>
                                        <th>Mar</th>
                                        <th>Mie</th>
                                        <th>Jue</th>
                                        <th>Vie</th>
                                        <th>Sab</th>
                                    </tr>
                                </thead>
                                <tbody id="calendar-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- FORMULARIO MODIFICADO -->
                <div class="form-section">
                    <div class="form-group">
                        <label>Día</label>
                        <select id="dia">
                            <option value="">Seleccione un día</option>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="Miércoles">Miércoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tutor</label>
                        <select id="tutor">
                            <option value="">Seleccione un tutor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Hora</label>
                        <select id="hora">
                            <option value="">Seleccione una hora</option>
                            <option value="08:00">08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                        </select>
                    </div>

                    <div class="buttons">
                        <button class="btn registrar">Registrar</button>
                        <button class="btn actualizar">Actualizar</button>
                        <button class="btn eliminar">Eliminar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
<script>
        let disponibilidades = [];
const API_URL = "http://localhost:3001/api/tutorias";

/* ========== ALERTAS ========== */
function mostrarAlerta(msg, tipo="ok") {
    const alerta = document.getElementById("alerta");
    alerta.innerText = msg;
    alerta.className = tipo === "ok" ? "alerta-ok" : "alerta-error";
    alerta.style.display = "block";

    setTimeout(() => alerta.style.display = "none", 2500);
}

/* ========== CARGAR TUTORES ========== */
async function cargarTutores() {
    const combo = document.getElementById("tutor");
    combo.innerHTML = `<option value="">Seleccione un tutor</option>`;

    try {
        const res = await fetch(`${API_URL}/tutores`);
        const data = await res.json();

        data.forEach(t => {
            const op = document.createElement("option");
            op.value = t.id_usuario;
            op.textContent = t.nombre_completo;
            combo.appendChild(op);
        });
    } catch (err) { console.log(err); }
}

/* ========== CARGAR DISPONIBILIDAD ========== */
async function cargarDisponibilidades() {
    try {
        const res = await fetch(`${API_URL}/disponibilidad`);
        disponibilidades = await res.json();

        // REGENERAR CALENDARIO CON DATOS
        const [year, month] = monthInput.value.split("-").map(Number);
        generarCalendario(year, month - 1);

    } catch (err) { console.log(err); }
}

/* ========== CALENDARIO ========== */
const monthInput = document.getElementById("mes");
const calendarBody = document.getElementById("calendar-body");

function generarCalendario(year, month) {
    calendarBody.innerHTML = "";
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    let date = 1;

    for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");

        for (let j = 0; j < 7; j++) {
            const cell = document.createElement("td");

            if (i === 0 && j < firstDay || date > lastDate) {
                cell.classList.add("empty");
            } else {

                const currentDate = new Date(year, month, date);
                const nombreDia = currentDate.toLocaleDateString("es-ES", { weekday: "long" });

                cell.textContent = date;

                // MARCAR DISPONIBILIDAD
                if (disponibilidades.some(d => d.dia.toLowerCase() === nombreDia.toLowerCase())) {
                    cell.classList.add("con-disponibilidad");
                }

                // CLIC PARA CARGAR FORMULARIO
                cell.addEventListener("click", () => seleccionarDiaConDatos(nombreDia, cell));

                date++;
            }

            row.appendChild(cell);
        }

        calendarBody.appendChild(row);
    }
}

function seleccionarDiaConDatos(nombreDia, cell) {
    document.querySelectorAll("td").forEach(td => td.classList.remove("selected"));
    cell.classList.add("selected");

    document.getElementById("dia").value =
        nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1);

    const lista = disponibilidades.filter(d =>
        d.dia.toLowerCase() === nombreDia.toLowerCase()
    );

    if (lista.length > 0) {
        document.getElementById("tutor").value = lista[0].id_usuario;
        document.getElementById("hora").value = lista[0].hora.substring(0, 5);
    } else {
        document.getElementById("tutor").value = "";
        document.getElementById("hora").value = "";
    }
}

monthInput.addEventListener("change", () => {
    const [y, m] = monthInput.value.split("-").map(Number);
    generarCalendario(y, m - 1);
});

/* ========== BOTÓN REGISTRAR ========== */
document.querySelector(".registrar").addEventListener("click", async () => {
    const id_usuario = document.getElementById("tutor").value;
    const dia = document.getElementById("dia").value;
    const hora = document.getElementById("hora").value;

    if (!id_usuario || !dia || !hora) return mostrarAlerta("Todos los campos son obligatorios", "error");

    const res = await fetch(`${API_URL}/disponibilidad`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id_usuario, dia, hora: hora + ":00" })
    });

    const data = await res.json();
    mostrarAlerta(data.mensaje, res.ok ? "ok" : "error");

    cargarDisponibilidades();
});

/* ========== BOTÓN ACTUALIZAR ========== */
document.querySelector(".actualizar").addEventListener("click", async () => {
    const id_usuario = document.getElementById("tutor").value;
    const dia = document.getElementById("dia").value;
    const hora = document.getElementById("hora").value;

    if (!id_usuario || !dia || !hora)
        return mostrarAlerta("Debe seleccionar un registro para actualizar", "error");

    const res = await fetch(`${API_URL}/disponibilidad`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id_usuario, dia, hora: hora + ":00" })
    });

    const data = await res.json();
    mostrarAlerta(data.mensaje, res.ok ? "ok" : "error");

    cargarDisponibilidades();
});

/* ========== BOTÓN ELIMINAR ========== */
document.querySelector(".eliminar").addEventListener("click", async () => {
    const id_usuario = document.getElementById("tutor").value;
    const dia = document.getElementById("dia").value;

    if (!id_usuario || !dia)
        return mostrarAlerta("Debe seleccionar un registro para eliminar", "error");

    const res = await fetch(`${API_URL}/disponibilidad`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id_usuario, dia })
    });

    const data = await res.json();
    mostrarAlerta(data.mensaje, res.ok ? "ok" : "error");

    cargarDisponibilidades();
});

/* ========== INICIALIZAR ========== */
(async () => {
    await cargarTutores();
    await cargarDisponibilidades();
})();
    </script>
</body>
</html>
