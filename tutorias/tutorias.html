<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorías - Coordinador</title>
    <link rel="stylesheet" href="css/tutorias.css">
    <style>
        .logout-btn {
            margin-left: 10px;
            background-color: #c62828;
            border: none;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background-color: #a31414;
        }

    </style>
</head>

<body>
    <div id="alerta"></div>

    <header class="header">
        <div class="logo">
            <img src="../images/logoITS.png" alt="Logo" class="logo-img">
            <span>Instituto Tecnológico de Saltillo</span>
        </div>

        <nav class="nav">
            <a href="..\inicioC.html">Inicio</a>
            <a href="..\gestionUsuarios.html">Usuarios</a>
            <a href="..\roles.html">Roles</a>
            <a href="..\proyectos.html">Proyectos</a>
            <a href="">Reportes</a>
            <a href="#">Eventos</a>
            <a href="tutorias.html">Tutorias</a>
        </nav>

        <div class="usuario">
            <span id="nombre-usuario">Coordinador</span>
            <img src="../images/user-icon.png" alt="usuario" class="usuario-img" width="25" height="25">
            <button id="btn-logout" class="logout-btn">Cerrar sesión</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h3>Menú</h3>
            <ul>
                <li><a href="#" class="active">Agenda</a></li>
                <li><a href="disponibilidad.html">Disponibilidad</a></li>
            </ul>
        </aside>

        <main class="main">
            <h2>Asesorías</h2>
            <h3>Agenda</h3>

            <div class="content-wrapper">

                <div class="tutoria-listado">
                    <h4>Asesorías Programadas</h4>
                    <table class="tutorias-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Emprendedor</th>
                                <th>Proyecto</th>
                                <th>Fecha</th>
                                <th>Hora Inicio</th>
                                <th>Hora Fin</th>
                            </tr>
                        </thead>
                        <tbody id="tutorias-body"></tbody>
                    </table>
                </div>

                <div class="calendario-container">
                    <div class="calendar">
                        <input type="month" id="mes" value="2023-01">
                        <div class="calendar-box">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Dom</th>
                                        <th>Lun</th>
                                        <th>Mar</th>
                                        <th>Mie</th>
                                        <th>Jue</th>
                                        <th>Vie</th>
                                        <th>Sab</th>
                                    </tr>
                                </thead>
                                <tbody id="calendar-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <input type="hidden" id="idTutoriaSeleccionada" value="">

                    <div class="form-group">
                        <label>Nombre del emprendedor</label>
                        <select id="emprendedor">
                            <option value="">Emprendedor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nombre del proyecto</label>
                        <select id="proyecto">
                            <option value="">Proyecto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Seleccionar tutor</label>
                        <select id="tutor">
                            <option value="">Tutor</option>
                        </select>
                    </div>


                    <div class="form-group">
                        <label>Fecha de asesoría</label>
                        <div class="row">
                            <select id="diaSelect"><option value="">Día</option></select>
                            <select id="mesSelect"><option value="">Mes</option></select>
                            <select id="anioSelect"><option value="">Año</option></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Hora Inicio</label>
                        <select id="hora_inicio">
                            <option value="">Seleccionar Hora Inicio</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Hora Fin</label>
                        <select id="hora_fin">
                            <option value="">Seleccionar Hora Fin</option>
                        </select>
                    </div>

                    <div class="buttons">
                        <button class="btn registrar">Registrar</button>
                        <button class="btn actualizar">Actualizar</button>
                        <button class="btn eliminar">Eliminar</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>

        // Carga de usuarios y alertas
        const nombre_usuario_logueado = localStorage.getItem("usuario");
        if (!nombre_usuario_logueado) {
            alert("Error: No se encontró nombre de usuario. Inicie sesión nuevamente.");
            window.location.href = "../login.html";
        } else {
            document.getElementById("nombre-usuario").textContent = nombre_usuario_logueado;
        }

        document.getElementById("btn-logout").addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "../login.html";
        });

        function mostrarAlerta(msg, tipo = "ok") {
            const alerta = document.getElementById("alerta");
            alerta.innerText = msg;
            alerta.className = tipo === "ok" ? "alerta-ok" : "alerta-error";
            alerta.style.display = "block";
            setTimeout(() => alerta.style.display = "none", 2500);
        }


        // Variables principales

        const API_URL = "http://localhost:3001/api/tutorias";

        const monthInput = document.getElementById("mes");
        const calendarBody = document.getElementById("calendar-body");

        const emprendedorSelect = document.getElementById("emprendedor");
        const proyectoSelect = document.getElementById("proyecto");
        const tutorSelect = document.getElementById("tutor");
        const diaSelect = document.getElementById("diaSelect");
        const mesSelect = document.getElementById("mesSelect");
        const anioSelect = document.getElementById("anioSelect");
        const horaInicioSelect = document.getElementById("hora_inicio");
        const horaFinSelect = document.getElementById("hora_fin"); // Nuevo
        const tutoriasBody = document.getElementById("tutorias-body");
        const idTutoriaInput = document.getElementById("idTutoriaSeleccionada");

        let listaTutorias = [];
        let disponibilidades = [];


        // Carga de datos iniciales (tutores, emprendedores, disponibilidad)

        async function cargarEmprendedores() {
            emprendedorSelect.innerHTML = `<option value="">Seleccione Emprendedor</option>`;
            try {
                const res = await fetch(`${API_URL}/emprendedores`);
                const data = await res.json();
                data.forEach(e => {
                    const op = document.createElement("option");
                    op.value = e.id_usuario;
                    op.textContent = e.nombre_completo;
                    emprendedorSelect.appendChild(op);
                });
            } catch (err) { console.error("Error al cargar emprendedores:", err); }
        }

        async function cargarProyectos(id_emprendedor) {
            proyectoSelect.innerHTML = `<option value="">Seleccione Proyecto</option>`;
            if (!id_emprendedor) return;

            try {
                const res = await fetch(`${API_URL}/proyectos/${id_emprendedor}`);
                const data = await res.json();
                data.forEach(p => {
                    const op = document.createElement("option");
                    op.value = p.id_proyecto;
                    op.textContent = p.nombre_proyecto;
                    proyectoSelect.appendChild(op);
                });
            } catch (err) { console.error("Error al cargar proyectos:", err); }
        }

        async function cargarTutores() {
            tutorSelect.innerHTML = `<option value="">Seleccione Tutor</option>`;
            try {
                const res = await fetch(`${API_URL}/tutores`);
                const data = await res.json();
                data.forEach(t => {
                    const op = document.createElement("option");
                    op.value = t.id_usuario;
                    op.textContent = t.nombre_completo;
                    tutorSelect.appendChild(op);
                });
            } catch (err) { console.error("Error al cargar tutores:", err); }
        }

        async function cargarDisponibilidades() {
            try {
                const res = await fetch(`${API_URL}/disponibilidad`);
                disponibilidades = await res.json();
            } catch (err) { console.error("Error al cargar disponibilidad:", err); }
        }

        // Logica de fecha y hora adaptada para los rangos

        // Convertir día de la semana a su nombre en español
        function getNombreDia(fechaStr) {
            const [year, month, day] = fechaStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay(); // 0=Dom, 1=Lun...
            const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
            return days[dayOfWeek];
        }

        // Genera opciones de hora dentro de un rango de 1 hora
        function generarOpcionesHora(minHour, maxHour, currentStart) {
            const options = [];
             for (let h = 8; h <= 17; h++) {
                const hourStr = String(h).padStart(2, '0') + ':00';
        
        // Lógica para generar opciones de HORA INICIO
        if (!currentStart) {
            if (hourStr >= minHour && hourStr < maxHour) {
                options.push(hourStr);
            }
        }

        // Lógica para generar opciones de HORA FIN
        else {
            if (hourStr > currentStart && hourStr <= maxHour) {
                options.push(hourStr);
            }
        }
    }
    return options;
}

function cargarHorasDisponibles() {
    horaInicioSelect.innerHTML = `<option value="">Seleccionar Hora Inicio</option>`;
    horaFinSelect.innerHTML = `<option value="">Seleccionar Hora Fin</option>`;

    const id_tutor = tutorSelect.value;
    const dia_num = diaSelect.value;
    const mes_num = mesSelect.value;
    const anio_num = anioSelect.value;

    if (!id_tutor || !dia_num || !mes_num || !anio_num) return;

    // Formato de fecha para obtener el nombre del día
    const fechaStr = `${anio_num}-${mes_num}-${dia_num}`;
    const nombreDia = getNombreDia(fechaStr);

    // Encontrar la disponibilidad del tutor para ese día
    const dispDia = disponibilidades.filter(d =>
        d.id_usuario == id_tutor && d.dia.toLowerCase() === nombreDia.toLowerCase()
    );

    if (dispDia.length === 0) {
        // Limpiar las horas si no hay disponibilidad
        horaInicioSelect.innerHTML = `<option value="">Tutor sin disponibilidad</option>`;
        horaFinSelect.innerHTML = `<option value="">Tutor sin disponibilidad</option>`;
        return mostrarAlerta(`El tutor no tiene disponibilidad el ${nombreDia}.`, "error");
    }

    // Usar la primera disponibilidad
    const disponibilidad = dispDia[0];
    const hora_min = disponibilidad.hora_inicio.substring(0, 5);
    const hora_max = disponibilidad.hora_fin.substring(0, 5);
    
    // Generar horas de inicio basadas en el rango del tutor
    const horasInicio = generarOpcionesHora(hora_min, hora_max, null);
    
    // Rellenar Hora Inicio
    horasInicio.forEach(h => {
        const op = document.createElement("option");
        op.value = h;
        op.textContent = h;
        horaInicioSelect.appendChild(op);
    });
    
    // Evento para actualizar Hora Fin cuando se selecciona Hora Inicio
    horaInicioSelect.onchange = () => {
        horaFinSelect.innerHTML = `<option value="">Seleccionar Hora Fin</option>`;
        const start = horaInicioSelect.value;
        if (!start) return;

        // Generar horas de fin que sean mayores a la hora de inicio seleccionada y dentro del rango máximo
        const horasFin = generarOpcionesHora(hora_min, hora_max, start);
        
        // Rellenar Hora Fin
        horasFin.forEach(h => {
            const op = document.createElement("option");
            op.value = h;
            op.textContent = h;
            horaFinSelect.appendChild(op);
        });
        
        // Si hay una hora de fin preseleccionada, intenta seleccionarla
        if (horaFinSelect.dataset.preselect) {
            horaFinSelect.value = horaFinSelect.dataset.preselect;
            delete horaFinSelect.dataset.preselect;
        }
    };

    // Si hay una hora de inicio preseleccionada, intenta seleccionarla
    if (horaInicioSelect.dataset.preselect) {
        horaInicioSelect.value = horaInicioSelect.dataset.preselect;
        horaInicioSelect.dispatchEvent(new Event("change"));
        delete horaInicioSelect.dataset.preselect;
    }
}


        // Calendario y fechas

        (function initFecha() {
            const now = new Date();
            const isoMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            monthInput.value = isoMonth;

            const nombresMes = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            mesSelect.innerHTML = "<option value=''>Mes</option>";
            for (let m = 1; m <= 12; m++) {
                const op = document.createElement("option");
                op.value = String(m).padStart(2, "0");
                op.textContent = nombresMes[m - 1];
                mesSelect.appendChild(op);
            }

            const currentYear = now.getFullYear();
            anioSelect.innerHTML = "<option value=''>Año</option>";
            for (let y = currentYear; y <= currentYear + 5; y++) {
                const op = document.createElement("option");
                op.value = y;
                op.textContent = y;
                anioSelect.appendChild(op);
            }

            mesSelect.addEventListener("change", () => {
                actualizarDias();
                cargarHorasDisponibles();
            });
            anioSelect.addEventListener("change", () => {
                actualizarDias();
                cargarHorasDisponibles();
            });
            diaSelect.addEventListener("change", cargarHorasDisponibles);
            tutorSelect.addEventListener("change", cargarHorasDisponibles);

        })();


        function actualizarDias() {
            const year = parseInt(anioSelect.value);
            const month = parseInt(mesSelect.value);
            diaSelect.innerHTML = "<option value=''>Día</option>";

            if (!year || !month) return;

            const dias = new Date(year, month, 0).getDate();

            for (let d = 1; d <= dias; d++) {
                const op = document.createElement("option");
                op.value = String(d).padStart(2, '0');
                op.textContent = d;
                diaSelect.appendChild(op);
            }
        }

        function generarCalendario(year, month) {
    calendarBody.innerHTML = "";
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    let date = 1;

    // Obtener tutor seleccionado
    const id_tutor = tutorSelect.value;

    for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");

        for (let j = 0; j < 7; j++) {
            const cell = document.createElement("td");

            if (i === 0 && j < firstDay || date > lastDate) {
                cell.classList.add("empty");

            } else {
                const dia = String(date).padStart(2, '0');
                const mes = String(month + 1).padStart(2, '0');
                const fechaStr = `${year}-${mes}-${dia}`;

                cell.textContent = date;

                // Marcar fechas disponibles
                if (id_tutor) {
                    const nombreDia = getNombreDia(fechaStr).toLowerCase();

                    const tieneDisponibilidad = disponibilidades.some(d =>
                        d.id_usuario == id_tutor &&
                        d.dia.toLowerCase() === nombreDia
                    );

                    if (tieneDisponibilidad) {
                        cell.classList.add("dia-disponible");
                    }
                }

                // click para seleccionar día
                cell.addEventListener("click", () => seleccionarDia(date, cell));
                date++;
            }
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);
    }
}


        function seleccionarDia(day, cell) {
    // Asegurar que day es número limpio
    const diaNumero = Number(String(day).trim());

    console.log("Día recibido:", diaNumero);

    if (isNaN(diaNumero)) {
        console.error("El día seleccionado NO es un número válido:", day);
        return;
    }

    // Limpia selección visual
    document.querySelectorAll("td").forEach(td => td.classList.remove("selected"));
    cell.classList.add("selected");

    // Si no hay mes/año se sincronizan desde monthInput
    if (!mesSelect.value || !anioSelect.value) {
        if (monthInput.value) {
            const [yy, mm] = monthInput.value.split("-").map(Number);
            anioSelect.value = yy;
            mesSelect.value = String(mm).padStart(2, '0');
        } else {
            mostrarAlerta("Seleccione Año y Mes primero.", "error");
            return;
        }
    }

    // Recargar el select de días
    actualizarDias();

    // Intentar seleccionar el día 
    const diaFormateado = String(diaNumero).padStart(2, '0');
    diaSelect.value = diaFormateado;

    console.log("Intentando seleccionar:", diaFormateado);

    // Verificar si se selecciono
    if (diaSelect.value !== diaFormateado) {
        console.error("No se pudo asignar el día al select.");
    }

    // Cargar horas
    cargarHorasDisponibles();
}


        
        monthInput.addEventListener("change", () => {
            const [y, m] = monthInput.value.split("-").map(Number);
            generarCalendario(y, m - 1);
        });
        
        // Carga de listado de tutorias
        async function cargarTutoriasListado() {
            try {
                const res = await fetch(`${API_URL}/tutorias-listado`);
                if (!res.ok) return;

                listaTutorias = await res.json();
                tutoriasBody.innerHTML = "";

                listaTutorias.forEach(t => {
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-id", t.id_tutoria);

                    const fechaObj = new Date(t.fecha);
                    const fechaFormato = fechaObj.toLocaleDateString("es-ES", {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    // Mostrar rango de horas
                    const horaInicioFormato = t.hora_inicio ? t.hora_inicio.substring(0, 5) : "N/A";
                    const horaFinFormato = t.hora_fin ? t.hora_fin.substring(0, 5) : "N/A";

                    tr.innerHTML = `
                        <td>${t.id_tutoria}</td>
                        <td>${t.nombre_emprendedor}</td>
                        <td>${t.nombre_proyecto}</td>
                        <td>${fechaFormato}</td>
                        <td>${horaInicioFormato}</td>
                        <td>${horaFinFormato}</td>
                    `;

                    tr.addEventListener("click", () => autocompletarFormulario(t));
                    tutoriasBody.appendChild(tr);
                });

            } catch (err) {
                console.error("Error al cargar listado:", err);
            }
        }

        // Autocompletar formulario
        async function autocompletarFormulario(t) {
    idTutoriaInput.value = t.id_tutoria;

    document.querySelectorAll(".tutorias-table tr")
        .forEach(row => row.classList.remove("selected"));

    const fila = document.querySelector(`[data-id="${t.id_tutoria}"]`);
    if (fila) fila.classList.add("selected");

    // Cargar Emprendedor y Proyectos
    emprendedorSelect.value = t.id_usuario;
    await cargarProyectos(t.id_usuario);
    proyectoSelect.value = t.id_proyecto;

    // Cargar Tutor
    tutorSelect.value = t.id_tutor;

    // Cargar Fecha
    const fechaObj = new Date(t.fecha);
    const day = String(fechaObj.getUTCDate()).padStart(2, '0');
    const month = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
    const year = fechaObj.getUTCFullYear();

    anioSelect.value = year;
    mesSelect.value = month;
    actualizarDias();
    diaSelect.value = day;

    const hora_inicio_pre = t.hora_inicio.substring(0, 5);
    const hora_fin_pre = t.hora_fin.substring(0, 5);

    // Guardar las horas en los dataset para que cargarHorasDisponibles las recoja
    horaInicioSelect.dataset.preselect = hora_inicio_pre;
    horaFinSelect.dataset.preselect = hora_fin_pre;

    cargarHorasDisponibles(); 
}

        //Botones de accion

        // Evento para deseleccionar la fila al cambiar cualquier campo
        [emprendedorSelect, proyectoSelect, tutorSelect, diaSelect, mesSelect, anioSelect, horaInicioSelect, horaFinSelect].forEach(element => {
            element.addEventListener('change', () => {
                idTutoriaInput.value = "";
                document.querySelectorAll(".tutorias-table tr")
                    .forEach(row => row.classList.remove("selected"));
            });
        });

        emprendedorSelect.addEventListener("change", () => cargarProyectos(emprendedorSelect.value));


        // REGISTRAR
        document.querySelector(".registrar").addEventListener("click", async () => {
            const id_usuario = emprendedorSelect.value;
            const id_tutor = tutorSelect.value;
            const id_proyecto = proyectoSelect.value;
            const fecha = `${anioSelect.value}-${mesSelect.value}-${diaSelect.value}`;
            const hora_inicio = horaInicioSelect.value;
            const hora_fin = horaFinSelect.value;

            if (!id_usuario || !id_tutor || !id_proyecto || !anioSelect.value || !mesSelect.value || !diaSelect.value || !hora_inicio || !hora_fin)
                return mostrarAlerta("Todos los campos son obligatorios", "error");

            const res = await fetch(`${API_URL}/registrar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id_usuario,
                    id_tutor,
                    id_proyecto,
                    fecha,
                    hora_inicio: hora_inicio + ":00",
                    hora_fin: hora_fin + ":00"
                })
            });

            const data = await res.json();
            mostrarAlerta(data.mensaje, res.ok ? "ok" : "error");

            if (res.ok) cargarTutoriasListado();
        });

        // ACTUALIZAR
        document.querySelector(".actualizar").addEventListener("click", async () => {
            const id_tutoria = idTutoriaInput.value;
            const id_usuario = emprendedorSelect.value;
            const id_tutor = tutorSelect.value;
            const id_proyecto = proyectoSelect.value;
            const fecha = `${anioSelect.value}-${mesSelect.value}-${diaSelect.value}`;
            const hora_inicio = horaInicioSelect.value;
            const hora_fin = horaFinSelect.value;

            if (!id_tutoria)
                return mostrarAlerta("Debe seleccionar una tutoría para actualizar", "error");

            if (!id_usuario || !id_tutor || !id_proyecto || !anioSelect.value || !mesSelect.value || !diaSelect.value || !hora_inicio || !hora_fin)
                return mostrarAlerta("Todos los campos son obligatorios", "error");


            const res = await fetch(`${API_URL}/registrar`, { // Usando el PUT de /registrar
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id_tutoria,
            id_usuario: emprendedorSelect.value,
            id_tutor: tutorSelect.value,
            id_proyecto: proyectoSelect.value,
            fecha: `${anioSelect.value}-${mesSelect.value}-${diaSelect.value}`,
            hora_inicio: horaInicioSelect.value + ":00",
            hora_fin: horaFinSelect.value + ":00"
                })
            });

            const data = await res.json();
            mostrarAlerta(data.mensaje, res.ok ? "ok" : "error");

            if (res.ok) cargarTutoriasListado();
        });


        // ELIMINAR
        document.querySelector(".eliminar").addEventListener("click", async () => {
            const id_tutoria = idTutoriaInput.value;

            if (!id_tutoria)
                return mostrarAlerta("Debe seleccionar una tutoría para eliminar", "error");

            if (!confirm("¿Está seguro de que desea eliminar esta tutoría?")) return;

            const res = await fetch(`${API_URL}/registrar`, { // Usando el DELETE de /registrar
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_tutoria })
            });

            const data = await res.json();
            mostrarAlerta(data.mensaje, res.ok ? "ok" : "error");

            if (res.ok) {
                idTutoriaInput.value = "";
                cargarTutoriasListado();
            }
        });


        // INICIALIZAR TODO
        (async () => {
            await cargarEmprendedores();
            await cargarTutores();
            await cargarDisponibilidades();
            await cargarTutoriasListado();

            tutorSelect.addEventListener("change", () => {
                if (!monthInput.value) {
                 alert("Seleccione un mes y año primero");
                return;
             }

            const [y, m] = monthInput.value.split("-").map(Number);
             generarCalendario(y, m - 1);
            });

monthInput.addEventListener("change", () => {
    if (!monthInput.value) return;
    const [yy, mm] = monthInput.value.split("-").map(Number);
    anioSelect.value = yy;
    mesSelect.value = String(mm).padStart(2, '0');
    actualizarDias();
    const [y, m] = [yy, mm];
    generarCalendario(y, m - 1);
});



            // Cargar el calendario para el mes actual
            const [y, m] = monthInput.value.split("-").map(Number);
            generarCalendario(y, m - 1);
        })();

    </script>

</body>

</html>